stages:
  - build
  - publish

variables:
  # Use the project's container registry
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  # Docker buildkit for better caching and performance
  DOCKER_BUILDKIT: 1

# Build and publish Docker image
build-and-publish:
  stage: build
  image: docker:27
  services:
    - docker:27-dind
  before_script:
    # Log in to GitLab Container Registry
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    # Build the runtime stage and tag it
    - docker build --target runtime -t "$IMAGE_NAME:$CI_COMMIT_SHA" -t "$IMAGE_NAME:latest" .
    
    # Push both tags
    - docker push "$IMAGE_NAME:$CI_COMMIT_SHA"
    - docker push "$IMAGE_NAME:latest"
    
    # If this is a tagged release, also push with the version tag
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag "$IMAGE_NAME:$CI_COMMIT_SHA" "$IMAGE_NAME:$CI_COMMIT_TAG"
        docker push "$IMAGE_NAME:$CI_COMMIT_TAG"
      fi
  rules:
    # Run on main branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    # Run on tags
    - if: $CI_COMMIT_TAG
    # Run on merge requests (optional - comment out if you don't want this)
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  tags:
    - docker

# Optional: Build and export the standalone binary as an artifact
build-binary:
  stage: build
  image: oven/bun:1
  script:
    - bun install
    - NODE_ENV=production bun build ./index.ts --compile --outfile ./dist/bibus
    - chmod +x ./dist/bibus
  artifacts:
    paths:
      - dist/bibus
    expire_in: 1 week
  rules:
    # Run on main branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    # Run on tags
    - if: $CI_COMMIT_TAG
  tags:
    - docker
